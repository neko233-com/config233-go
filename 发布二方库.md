# 发布二方库

本文档介绍如何将 config233-go 作为二方库发布和管理，不对外公开但可供内部下载使用。

## 二方库概述

二方库是指公司内部的私有 Go 模块，不发布到公共的 Go 模块代理（如 proxy.golang.org），但可以在公司内部网络中下载和使用。

## 发布策略

### 1. 私有 Git 仓库

**推荐方案：使用公司内部的 Git 服务器**

1. **创建私有仓库**
   ```bash
   # 在公司 Git 服务器上创建私有仓库
   # 例如：git.company.com/internal/config233-go
   ```

2. **推送代码**
   ```bash
   git remote add origin git@company.com:internal/config233-go.git
   git push -u origin main
   ```

3. **版本管理**
   ```bash
   # 创建版本标签
   git tag v1.0.0
   git push origin v1.0.0
   ```

### 2. Go Module 配置

**go.mod 文件配置**
```go.mod
module git.company.com/internal/config233-go

go 1.21

require (
    github.com/fsnotify/fsnotify v1.7.0
    github.com/xuri/excelize/v2 v2.7.1
)
```

### 3. 内部 Go Module Proxy

**设置内部代理服务器**

如果公司有内部的 Go module proxy（如 Artifactory、Nexus 等）：

1. **配置 GOPROXY**
   ```bash
   export GOPROXY="https://artifactory.company.com/artifactory/api/go/go,https://proxy.golang.org,direct"
   ```

2. **私有模块配置**
   ```bash
   export GOPRIVATE="git.company.com/internal/*"
   ```

## 使用方式

### 1. 内部项目中使用

```go
// go.mod
module git.company.com/project/xxx

require (
    git.company.com/internal/config233-go v1.0.0
)

replace git.company.com/internal/config233-go => ../relative/path/to/config233-go
```

### 2. 开发环境配置

**~/.gitconfig 配置**
```ini
[url "git@company.com:"]
    insteadOf = https://company.com/
```

**Go 环境配置**
```bash
# .bashrc 或 .zshrc
export GOPRIVATE="git.company.com/internal/*"
export GONOPROXY="git.company.com/internal/*"
export GOSUMDB=off  # 如果不需要校验和数据库
```

### 3. CI/CD 集成

**GitLab CI 示例**
```yaml
variables:
  GOPRIVATE: "git.company.com/internal/*"
  GONOPROXY: "git.company.com/internal/*"

before_script:
  - git config --global url."git@company.com:".insteadOf "https://company.com/"
  - mkdir -p ~/.ssh
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - ssh-keyscan -H company.com >> ~/.ssh/known_hosts
```

## 版本管理

### 语义化版本

遵循 [语义化版本](https://semver.org/) 规范：

- **MAJOR.MINOR.PATCH** (主版本.次版本.补丁版本)
- **v1.0.0**: 初始稳定版本
- **v1.1.0**: 向后兼容的功能更新
- **v2.0.0**: 不向后兼容的重大更改

### 发布流程

1. **代码审查**
```bash
   # 确保代码通过所有测试
   go test ./...
   go build .
```

2. **更新版本**
```bash
   # 更新版本号
   git tag v1.1.0
   git push origin v1.1.0
```

3. **文档更新**
   - 更新 CHANGELOG.md
   - 更新 README.md 中的版本信息

## 依赖管理

### 私有依赖处理

如果二方库依赖其他私有库：

```go.mod
require (
    git.company.com/internal/common-lib v1.0.0
)

replace git.company.com/internal/common-lib => ../common-lib
```

### 许可证管理

- 使用公司内部许可证
- 不要使用开源许可证（如 MIT, Apache 2.0）
- 在代码注释中添加版权声明

## 安全考虑

### 1. 访问控制

- 使用 SSH 密钥认证
- 配置适当的仓库权限
- 定期轮换访问令牌

### 2. 代码安全

- 定期安全审计
- 避免硬编码敏感信息
- 使用公司内部的安全扫描工具

### 3. 网络安全

- 使用 HTTPS 传输
- 配置防火墙规则
- 监控异常访问

## 故障排除

### 常见问题

1. **无法下载私有模块**
   ```bash
   # 检查 GOPRIVATE 设置
   echo $GOPRIVATE

   # 检查 SSH 配置
   ssh -T git@company.com
   ```

2. **版本冲突**
   ```bash
   # 清理模块缓存
   go clean -modcache

   # 重新下载依赖
   go mod download
   ```

3. **代理问题**
   ```bash
   # 检查代理设置
   echo $GOPROXY
   echo $GONOPROXY
   ```

## 维护建议

### 1. 定期更新

- 保持依赖项更新
- 修复安全漏洞
- 改进性能

### 2. 文档维护

- 保持 README.md 更新
- 编写使用示例
- 记录 breaking changes

### 3. 社区建设

- 建立内部使用者群组
- 收集反馈和建议
- 定期发布更新

## 迁移指南

### 从本地依赖迁移到二方库

1. **原有方式（本地路径）**
   ```go.mod
   replace config233-go => ../config233-go
   ```

2. **新方式（二方库）**
   ```go.mod
   require git.company.com/internal/config233-go v1.0.0
   ```

3. **平滑迁移**
   ```go.mod
   require git.company.com/internal/config233-go v1.0.0

   replace git.company.com/internal/config233-go => ../config233-go
   ```

   迁移完成后移除 replace 指令。